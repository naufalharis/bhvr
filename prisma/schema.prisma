generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUM
enum CourseType {
  single
  bundle
}

enum ContentType {
  video
  slide
  download
}

// ======================
// MODELS
// ======================

model User {
  id            String   @id @default(uuid())
  first_name    String
  last_name     String?
  gender        String?
  mobile_number String?
  birth_date    DateTime?
  birth_place   String?
  username      String   @unique
  email         String   @unique
  password      String
  role          String

  affiliates  Affiliate[]
  instructors Instructor[]
  enrolled    EnrolledCourse[]
  orders      Order[]
  notes       CourseNote[]
}

model Affiliate {
  id              String   @id @default(uuid())
  user_id         String
  registered_date DateTime @default(now())
  unique_code     String   @unique
  status          String

  user    User                @relation(fields: [user_id], references: [id])
  courses AffiliatesCourses[]
}

model AffiliatesCourses {
  id              String   @id @default(uuid())
  affiliate_id    String
  course_id       String
  registered_date DateTime @default(now())

  affiliate Affiliate @relation(fields: [affiliate_id], references: [id])
  course    Course    @relation(fields: [course_id], references: [id])
}

model Instructor {
  id              String   @id @default(uuid())
  user_id         String   @unique
  registered_date DateTime @default(now())
  status          String

  user    User     @relation(fields: [user_id], references: [id])
  courses Course[]
}

model Course {
  id            String        @id @default(uuid())
  instructor_id String
  title         String
  overview      String?
  cover         String?
  course_type   CourseType
  slug          String        @unique

  instructor     Instructor          @relation(fields: [instructor_id], references: [id])
  categories     CoursesCategories[]
  chapters       CourseChapter[]
  enrolled       EnrolledCourse[]
  orderLines     OrderLine[]
  productDetails ProductDetail[]
  affiliates     AffiliatesCourses[]
}

model CoursesCategories {
  id          String   @id @default(uuid())
  course_id   String
  category_id String

  course   Course   @relation(fields: [course_id], references: [id])
  category Category @relation(fields: [category_id], references: [id])
}

model Category {
  id        String   @id @default(uuid())
  parent_id String?
  title     String

  parent   Category?           @relation("CategoryChildren", fields: [parent_id], references: [id])
  children Category[]          @relation("CategoryChildren")
  courses  CoursesCategories[]
}

model CourseChapter {
  id         String   @id @default(uuid())
  course_id  String
  title      String
  overview   String?
  cover      String?
  sort_order Int?

  course   Course                 @relation(fields: [course_id], references: [id])
  contents CourseChapterContent[]
}

model CourseChapterContent {
  id                 String      @id @default(uuid())
  chapter_id         String
  title              String
  overview           String?
  cover              String?
  content_type       ContentType
  sort_order         Int?
  path               String?
  original_file_name String?

  chapter CourseChapter @relation(fields: [chapter_id], references: [id])
  notes   CourseNote[]
}

model EnrolledCourse {
  id            String   @id @default(uuid())
  user_id       String
  course_id     String
  order_id      String?
  bundle_id     String?
  enrolled_date DateTime @default(now())
  order         String?

  user     User         @relation(fields: [user_id], references: [id])
  course   Course       @relation(fields: [course_id], references: [id])
  orderRef Order?       @relation(fields: [order_id], references: [id])
  notes    CourseNote[]
}

model CourseNote {
  id                       String   @id @default(uuid())
  enrolled_course_id       String
  course_content_detail_id String
  user_id                  String
  note                     String?

  enrolledCourse EnrolledCourse       @relation(fields: [enrolled_course_id], references: [id])
  content        CourseChapterContent @relation(fields: [course_content_detail_id], references: [id])
  user           User                 @relation(fields: [user_id], references: [id])
}

model Order {
  id         String   @id @default(uuid())
  user_id    String
  order_date DateTime @default(now())
  status     String

  user     User             @relation(fields: [user_id], references: [id])
  payments OrderPayment[]
  lines    OrderLine[]
  enrolled EnrolledCourse[]
}

model OrderLine {
  id         String   @id @default(uuid())
  order_id   String
  product_id String
  course_id  String?
  status     String

  order   Order   @relation(fields: [order_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])
  course  Course? @relation(fields: [course_id], references: [id])
}

model OrderPayment {
  id               String   @id @default(uuid())
  order_id         String
  payment_date     DateTime @default(now())
  method           String
  status           String
  reference_number String?

  order Order @relation(fields: [order_id], references: [id])
}

model Product {
  id           String   @id @default(uuid())
  title        String
  overview     String?
  cover        String?
  product_type String
  price        Float

  orderLines OrderLine[]
  details    ProductDetail[]
}

model ProductDetail {
  id         String   @id @default(uuid())
  course_id  String
  product_id String?
  price      Float

  course  Course   @relation(fields: [course_id], references: [id])
  product Product? @relation(fields: [product_id], references: [id])
}

model Page {
  id      String   @id @default(uuid())
  title   String
  content String?
  is_main Boolean  @default(false)
  slug    String   @unique
}
